# Firebase Setup Guide

This project now uses Firebase Firestore to store forms and form submissions. Follow these steps to set up Firebase for your project.

## Prerequisites

1. A Firebase account (sign up at https://firebase.google.com)
2. A Firebase project created in the Firebase Console

## Setup Steps

### 1. Create a Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Click "Add project" or select an existing project
3. Follow the setup wizard

### 2. Enable Firestore Database

1. In your Firebase project, go to **Firestore Database**
2. Click **Create database**
3. Choose **Start in production mode** (or test mode for development)
4. Select a location for your database
5. Click **Enable**

### 3. Get Firebase Configuration

#### For Client-Side (Optional - if you need client-side Firebase access)

1. Go to **Project Settings** (gear icon)
2. Scroll down to **Your apps**
3. Click the **Web** icon (`</>`)
4. Register your app (give it a nickname)
5. Copy the Firebase configuration object

#### For Server-Side (Required)

You have two options:

**Option A: Service Account Key (Recommended for Production)**

1. Go to **Project Settings** → **Service Accounts**
2. Click **Generate new private key**
3. Download the JSON file
4. Copy the entire contents of the JSON file

**Option B: Application Default Credentials (For local development)**

If you're using Firebase emulator or have Application Default Credentials set up, you can use this method.

### 4. Set Environment Variables

Create a `.env.local` file in the root of your project (or update your existing `.env.local`):

```bash
# Firebase Admin SDK (Server-Side)
# Option A: Service Account Key (paste the entire JSON as a single line)
FIREBASE_SERVICE_ACCOUNT_KEY='{"type":"service_account","project_id":"your-project-id",...}'

# OR Option B: Project ID only (for emulator or Application Default Credentials)
FIREBASE_PROJECT_ID=your-project-id

# Firebase Client SDK (Optional - only if you need client-side access)
NEXT_PUBLIC_FIREBASE_API_KEY=your-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your-project-id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
NEXT_PUBLIC_FIREBASE_APP_ID=your-app-id
```

### 5. Set Up Firestore Security Rules

Go to **Firestore Database** → **Rules** and add these rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Forms collection - readable by anyone (for public forms)
    // Writable only by authenticated admin users
    match /forms/{formId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Form submissions - readable/writable only by authenticated admin users
    match /formSubmissions/{submissionId} {
      allow read: if request.auth != null;
      allow write: if true; // Allow form submissions from public
    }
  }
}
```

**Note:** For production, you should implement proper authentication and more restrictive rules.

### 6. Install Dependencies

The Firebase dependencies are already added to `package.json`. Run:

```bash
pnpm install
```

## Firestore Collections

The application uses two Firestore collections:

### 1. `forms` Collection

Stores form definitions:
- Document ID: Short 8-character ID (e.g., "AbC123Xy")
- Fields:
  - `title` (string): Form title
  - `description` (string): Form description
  - `questions` (array): Array of question objects
  - `createdAt` (timestamp): When the form was created
  - `expiresAt` (timestamp): When the form expires (10 days from creation)

### 2. `formSubmissions` Collection

Stores form submissions:
- Document ID: Auto-generated by Firestore
- Fields:
  - `formId` (string): Reference to the form ID
  - `formTitle` (string): Form title at time of submission
  - `formDescription` (string): Form description at time of submission
  - `name` (string): Submitter's name
  - `email` (string): Submitter's email
  - `answers` (object): Object containing all form answers
  - `submittedAt` (timestamp): When the form was submitted
  - `pageUrl` (string): URL where the form was submitted

## API Endpoints

### POST `/api/forms/store`

Creates a new form and stores it in Firestore.

**Request Body:**
```json
{
  "title": "Form Title",
  "description": "Form Description",
  "questions": [...]
}
```

**Response:**
```json
{
  "success": true,
  "id": "AbC123Xy",
  "url": "/forms/client/AbC123Xy"
}
```

### GET `/api/forms/store?id={formId}`

Retrieves a form from Firestore.

**Response:**
```json
{
  "success": true,
  "data": {
    "title": "Form Title",
    "description": "Form Description",
    "questions": [...],
    "createdAt": "2024-01-01T00:00:00.000Z",
    "expiresAt": 1704067200000
  }
}
```

### POST `/api/forms/submissions`

Stores a form submission in Firestore.

**Request Body:**
```json
{
  "formId": "AbC123Xy",
  "formTitle": "Form Title",
  "formDescription": "Form Description",
  "name": "John Doe",
  "email": "john@example.com",
  "answers": {...},
  "pageUrl": "https://example.com/forms/client/AbC123Xy"
}
```

### GET `/api/forms/submissions?formId={formId}&limit={limit}`

Retrieves form submissions. Optionally filter by `formId` and limit results.

**Response:**
```json
{
  "success": true,
  "submissions": [...],
  "count": 10
}
```

## Troubleshooting

### Error: "Firebase Admin SDK not configured"

Make sure you've set either `FIREBASE_SERVICE_ACCOUNT_KEY` or `FIREBASE_PROJECT_ID` in your `.env.local` file.

### Error: "Permission denied"

Check your Firestore security rules. Make sure they allow the operations you're trying to perform.

### Forms not persisting

- Check that Firestore is enabled in your Firebase project
- Verify your environment variables are set correctly
- Check the server logs for Firebase errors

## Local Development with Firebase Emulator

If you want to use the Firebase emulator for local development:

1. Install Firebase CLI: `npm install -g firebase-tools`
2. Initialize Firebase: `firebase init`
3. Start the emulator: `firebase emulators:start`
4. Set `FIREBASE_PROJECT_ID` to your project ID (the emulator will handle the rest)

## Production Deployment

For production deployments (e.g., Vercel):

1. Add all environment variables to your hosting platform's environment variable settings
2. Make sure `FIREBASE_SERVICE_ACCOUNT_KEY` is set as a single-line JSON string
3. Ensure Firestore security rules are properly configured for production

